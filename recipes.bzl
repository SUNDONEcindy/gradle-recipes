load("//tools/base/common:version.bzl", "DEV_BUILD_VERSION", "RELEASE_BUILD_VERSION")

def recipe_test(
        name,
        size = "enormous",
        timeout = "long"):
    """Sets up and runs a recipe test per AGP version to be tested

    Args:
      name: name of the directory containing the recipe project
      size : size of the Java test. See
        https://docs.bazel.build/versions/master/be/common-definitions.html#test.size
      timeout : timeout of the Java test. See
        https://docs.bazel.build/versions/master/be/common-definitions.html#test.timeout
    """

    # Test scenarios keyed by AGP version. Keep in chronological order, with "ToT" (tip of tree) last.

    test_scenarios = {
        "8.1.0": {
            "name": name + "_8_1_0",
            "gradle_path": "$(location //tools/base/build-system:gradle-distrib-8.0)",
            "manifest_repos": [
                "//tools/base/build-system/previous-versions:8.1.0",
                ":kotlin_1_8_10",
                "//tools/base/build-system:gradle-8.0-runtime-maven",
            ],
            "zip_repos": [],
            "data": [
                "//prebuilts/studio/sdk:build-tools/33.0.1",
                "//tools/base/build-system:gradle-distrib-8.0",
            ],
            "jdk_version": 17,
        },
        "8.2.0": {
            "name": name + "_8_2_0",
            "gradle_path": "$(location //tools/base/build-system:gradle-distrib-8.2)",
            "manifest_repos": [
                "//tools/base/build-system/previous-versions:8.2.0",
                ":kotlin_1_8_10",
                "//tools/base/build-system:gradle-8.2-runtime-maven",
            ],
            "zip_repos": [],
            "data": [
                "//prebuilts/studio/sdk:build-tools/34.0.0",
                "//tools/base/build-system:gradle-distrib-8.2",
            ],
            "jdk_version": 17,
        },
        "8.3.1": {
            "name": name + "_8_3_1",
            "gradle_path": "$(location //tools/base/build-system:gradle-distrib-8.4)",
            "manifest_repos": [
                "//tools/base/build-system/previous-versions:8.3.1",
                ":kotlin_1_9_22",
                "//tools/base/build-system:gradle-8.4-runtime-maven",
            ],
            "zip_repos": [],
            "data": [
                "//prebuilts/studio/sdk:build-tools/34.0.0",
                "//tools/base/build-system:gradle-distrib-8.4",
            ],
            "jdk_version": 17,
        },
        "8.4.0": {
            "name": name + "_8_4_0",
            "gradle_path": "$(location //tools/base/build-system:gradle-distrib-8.6)",
            "manifest_repos": [
                "//tools/base/build-system/previous-versions:8.4.0",
                ":kotlin_1_9_22",
                "//tools/base/build-system:gradle-8.6-runtime-maven",
            ],
            "zip_repos": [],
            "data": [
                "//prebuilts/studio/sdk:build-tools/34.0.0",
                "//tools/base/build-system:gradle-distrib-8.6",
            ],
            "jdk_version": 17,
        },
        "8.5.0": {
            "name": name + "_8_5_0",
            "gradle_path": "$(location //tools/base/build-system:gradle-distrib-8.7)",
            "manifest_repos": [
                "//tools/base/build-system/previous-versions:8.5.0",
                ":kotlin_1_9_22",
                "//tools/base/build-system:gradle-8.7-runtime-maven",
            ],
            "zip_repos": [],
            "data": [
                "//prebuilts/studio/sdk:build-tools/34.0.0",
                "//tools/base/build-system:gradle-distrib-8.7",
            ],
            "jdk_version": 17,
        },
        "8.6.0": {
            "name": name + "_8_6_0",
            "gradle_path": "$(location //tools/base/build-system:gradle-distrib-8.9)",
            "manifest_repos": [
                "//tools/base/build-system/previous-versions:8.6.0",
                "//tools/base/build-system/integration-test:kotlin_gradle_plugin_prebuilts",
                ":kotlin_1_9_22",
                "//tools/base/build-system:gradle-8.9-runtime-maven",
            ],
            "zip_repos": [],
            "data": [
                "//prebuilts/studio/sdk:build-tools/34.0.0",
                "//tools/base/build-system:gradle-distrib-8.9",
            ],
            "jdk_version": 17,
        },
        "8.7.0": {
            "name": name + "_8_7_0",
            "gradle_path": "$(location //tools/base/build-system:gradle-distrib-8.9)",
            "manifest_repos": [
                "//tools/base/build-system/previous-versions:8.7.0",
                "//tools/base/build-system/integration-test:kotlin_gradle_plugin_prebuilts",
                ":kotlin_1_9_22",
                "//tools/base/build-system:gradle-8.9-runtime-maven",
            ],
            "zip_repos": [],
            "data": [
                "//prebuilts/studio/sdk:build-tools/34.0.0",
                "//tools/base/build-system:gradle-distrib-8.9",
            ],
            "jdk_version": 17,
        },
        "ToT": {
            "name": name,
            "gradle_path": "$(location //tools/base/build-system:gradle-distrib)",
            "manifest_repos": [
                "//tools/base/build-system/integration-test:kotlin_gradle_plugin_prebuilts",
                ":kotlin_1_9_22",
                "//tools/base/build-system:gradle-runtime-maven",
            ],
            "zip_repos": ["//tools/base/build-system:android_gradle_plugin"],
            "data": [
                "//prebuilts/studio/sdk:build-tools/latest",
                "//tools/base/build-system:gradle-distrib",
            ],
        },
    }

    for agp_version in test_scenarios:
        manifest_repos = [
            "//tools/base/build-system:android_gradle_plugin_runtime_dependencies",
        ] + test_scenarios[agp_version]["manifest_repos"]
        zip_repos = test_scenarios[agp_version]["zip_repos"]
        repo_files = [repo + ".manifest" for repo in manifest_repos] + [repo + ".zip" for repo in zip_repos]

        native.java_test(
            name = test_scenarios[agp_version]["name"],
            size = size,
            timeout = timeout,
            jvm_flags = [
                            "-Dgradle_path=" + test_scenarios[agp_version]["gradle_path"],
                            "-Drepos=" + ",".join(["$(location " + repo_file + ")" for repo_file in repo_files]),
                            "-Dname=" + name,
                            "-Dversion_mappings_file=$(location :version_mappings.txt)",
                            "-Dall_tested_agp_versions=" + ",".join(test_scenarios),
                            "-Dconvert_debug=true",
                            "-Dvalidate_source=" + ("true" if agp_version == "ToT" else "false"),
                        ] +
                        (["-Djdk_version=" + str(test_scenarios[agp_version].get("jdk_version"))] if test_scenarios[agp_version].get("jdk_version") else []) +
                        (select({
                            "//tools/base/bazel:release": ["-Dagp_version=" + RELEASE_BUILD_VERSION],
                            "//conditions:default": ["-Dagp_version=" + DEV_BUILD_VERSION],
                        }) if agp_version == "ToT" else ["-Dagp_version=" + agp_version]),
            data = native.glob(
                [
                    "recipes/" + name + "/**",
                    "gradle-resources/**",
                ],
            ) + [
                "//tools/base/build-system:android_platform_for_agp_unit_tests",
                "version_mappings.txt",
            ] + manifest_repos + zip_repos + repo_files + test_scenarios[agp_version]["data"] + _jdkRuntime(test_scenarios[agp_version].get("jdk_version")),
            test_class = "com.android.tools.gradle.GradleRecipeTest",
            runtime_deps = [":gradle_recipe_test"],
        )

def _jdkRuntime(jdk_version):
    if jdk_version == 17:
        return ["//prebuilts/studio/jdk/jdk17:java_runtime"]
    elif jdk_version == 11:
        return ["//prebuilts/studio/jdk/jdk11:java_runtime"]
    else:
        return ["//prebuilts/studio/jdk/jdk17:java_runtime"]
